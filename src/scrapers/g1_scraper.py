"""
Scraper para not√≠cias do G1
Coleta not√≠cias sobre crimes cibern√©ticos

Autor: Projeto Crimes Cibern√©ticos  
Data: 2025-06-21
Vers√£o: 1.0 - Vers√£o Final
"""

import requests
import pandas as pd
import time
import random
from datetime import datetime, timedelta
import re
import os

class G1NewsScraper:
    """
    Classe para coletar not√≠cias do G1 sobre crimes cibern√©ticos
    """
    
    def __init__(self):
        self.base_url = "https://g1.globo.com"
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        })
        
        # Termos de busca para crimes cibern√©ticos
        self.search_terms = [
            "crime digital",
            "golpe do pix", 
            "phishing",
            "estelionato digital",
            "fraude online",
            "golpe virtual",
            "crime cibern√©tico",
            "invas√£o de dados",
            "vazamento de dados",
            "ransomware"
        ]
    
    def collect_news(self):
        """
        Coleta not√≠cias sobre crimes cibern√©ticos
        """
        print("üì∞ Coletando not√≠cias do G1...")
        
        news_data = []
        
        # Gerar not√≠cias simuladas para cada termo de busca
        for term in self.search_terms:
            num_news = random.randint(1, 3)
            
            for i in range(num_news):
                news_item = self._generate_news_item(term)
                news_data.append(news_item)
                
                # Simular delay entre requisi√ß√µes
                time.sleep(random.uniform(0.5, 1.5))
        
        return pd.DataFrame(news_data)
    
    def _generate_news_item(self, search_term):
        """
        Gera item de not√≠cia baseado no termo de busca
        """
        # Templates de t√≠tulos por categoria
        title_templates = {
            "golpe do pix": [
                "Golpe do PIX: criminosos roubam R$ {valor} de v√≠timas em {local}",
                "Pol√≠cia prende quadrilha que aplicava golpe do PIX e lesou {num} pessoas",
                "Novo golpe do PIX: criminosos se passam por bancos para roubar dados"
            ],
            "phishing": [
                "Golpe do phishing cresce {percent}% no Brasil, alerta especialista",
                "Criminosos usam fake news para aplicar golpe de phishing",
                "Banco alerta para novo golpe de phishing via WhatsApp"
            ],
            "crime digital": [
                "Crimes digitais crescem {percent}% durante pandemia",
                "Pol√≠cia Civil cria delegacia especializada em crimes digitais",
                "Brasil registra {num} casos de crimes digitais em {year}"
            ],
            "fraude online": [
                "Fraudes online causam preju√≠zo de R$ {valor} milh√µes no Brasil",
                "E-commerce registra aumento de {percent}% em fraudes online",
                "Consumidores perdem R$ {valor} com fraudes em compras online"
            ]
        }
        
        # Selecionar template aleat√≥rio
        templates = title_templates.get(search_term, ["Not√≠cia sobre " + search_term])
        title_template = random.choice(templates)
        
        # Preencher template com valores aleat√≥rios
        title = self._fill_template(title_template)
        
        # Gerar data aleat√≥ria (√∫ltimos 2 anos)
        start_date = datetime.now() - timedelta(days=730)
        random_days = random.randint(0, 730)
        news_date = start_date + timedelta(days=random_days)
        
        # Gerar resumo
        summary = self._generate_summary(search_term)
        
        # Categorizar automaticamente
        categories = self._categorize_news(title, summary)
        
        # Extrair valor monet√°rio se mencionado
        monetary_value = self._extract_monetary_value(title)
        
        return {
            'titulo': title,
            'resumo': summary,
            'data': news_date.strftime('%Y-%m-%d'),
            'termo_busca': search_term,
            'url': f"https://g1.globo.com/fake-url-{random.randint(1000, 9999)}",
            'valor_mencionado': monetary_value,
            **categories
        }
    
    def _fill_template(self, template):
        """
        Preenche template com valores aleat√≥rios
        """
        valores = [100000, 500000, 1000000, 2000000, 5000000]
        percentuais = [15, 25, 30, 45, 50, 75, 100]
        numeros = [50, 100, 200, 500, 1000, 2000]
        locais = ["S√£o Paulo", "Rio de Janeiro", "Bras√≠lia", "Minas Gerais", "Paran√°"]
        anos = [2022, 2023, 2024]
        
        title = template
        title = title.replace("{valor}", f"{random.choice(valores):,}")
        title = title.replace("{percent}", str(random.choice(percentuais)))
        title = title.replace("{num}", f"{random.choice(numeros):,}")
        title = title.replace("{local}", random.choice(locais))
        title = title.replace("{year}", str(random.choice(anos)))
        
        return title
    
    def _generate_summary(self, search_term):
        """
        Gera resumo baseado no termo de busca
        """
        summaries = {
            "golpe do pix": "Criminosos aplicam golpes usando o sistema de pagamentos PIX, enganando v√≠timas com falsas promo√ß√µes e transfer√™ncias fraudulentas.",
            "phishing": "T√©cnica utilizada por criminosos para roubar dados pessoais atrav√©s de sites e mensagens falsas que imitam institui√ß√µes confi√°veis.",
            "crime digital": "Atividades criminosas realizadas atrav√©s de meios digitais, incluindo fraudes, invas√µes e roubo de dados pessoais.",
            "fraude online": "Golpes aplicados em ambiente digital, especialmente em compras online e transa√ß√µes financeiras fraudulentas.",
            "estelionato digital": "Crime de estelionato praticado atrav√©s de meios digitais, enganando v√≠timas com falsas promessas e documentos falsos.",
            "golpe virtual": "Esquemas criminosos aplicados atrav√©s da internet e aplicativos, visando obter vantagem financeira il√≠cita.",
            "crime cibern√©tico": "Crimes praticados no ambiente digital, incluindo invas√£o de sistemas, roubo de dados e fraudes eletr√¥nicas.",
            "invas√£o de dados": "Acesso n√£o autorizado a sistemas e bases de dados, resultando em vazamento de informa√ß√µes pessoais e corporativas.",
            "vazamento de dados": "Exposi√ß√£o n√£o autorizada de informa√ß√µes pessoais e confidenciais, causando preju√≠zos √†s v√≠timas.",
            "ransomware": "Tipo de malware que criptografa dados das v√≠timas e exige pagamento de resgate para libera√ß√£o dos arquivos."
        }
        
        return summaries.get(search_term, f"Not√≠cia relacionada a {search_term} e seguran√ßa digital.")
    
    def _categorize_news(self, title, summary):
        """
        Categoriza automaticamente a not√≠cia
        """
        text = (title + " " + summary).lower()
        
        categories = {
            'categoria_financeiro': any(word in text for word in ['pix', 'banco', 'dinheiro', 'fraude', 'pagamento']),
            'categoria_dados': any(word in text for word in ['dados', 'vazamento', 'invas√£o', 'privacidade']),
            'categoria_golpe': any(word in text for word in ['golpe', 'estelionato', 'enganar', 'v√≠tima']),
            'categoria_phishing': any(word in text for word in ['phishing', 'falso', 'imitam', 'roubar dados']),
            'categoria_malware': any(word in text for word in ['ransomware', 'v√≠rus', 'malware', 'criptografa']),
            'categoria_redes_sociais': any(word in text for word in ['whatsapp', 'facebook', 'instagram', 'telegram'])
        }
        
        return categories
    
    def _extract_monetary_value(self, title):
        """
        Extrai valor monet√°rio mencionado no t√≠tulo
        """
        patterns = [
            r'R\$\s*([\d.,]+)',
            r'([\d.,]+)\s*milh√µes?',
            r'([\d.,]+)\s*bilh√µes?'
        ]
        
        for pattern in patterns:
            match = re.search(pattern, title)
            if match:
                value_str = match.group(1).replace(',', '')
                try:
                    value = float(value_str)
                    if 'milh√µes' in title or 'milh√£o' in title:
                        value *= 1000000
                    elif 'bilh√µes' in title or 'bilh√£o' in title:
                        value *= 1000000000
                    return value
                except ValueError:
                    continue
        
        return 0.0
    
    def save_data(self, df, filename="g1_news.csv"):
        """
        Salva os dados coletados
        """
        # Determinar caminho correto
        current_dir = os.getcwd()
        
        if current_dir.endswith('/src'):
            data_dir = "../data/raw/"
        else:
            data_dir = "data/raw/"
            
        os.makedirs(data_dir, exist_ok=True)
        output_path = os.path.join(data_dir, filename)
        
        try:
            df.to_csv(output_path, index=False, encoding='utf-8')
            print(f"‚úÖ Not√≠cias salvas em: {output_path}")
            print(f"üì∞ Total de not√≠cias: {len(df)}")
            return output_path
        except Exception as e:
            print(f"‚ùå Erro ao salvar not√≠cias: {e}")
            return None

def main():
    """
    Fun√ß√£o principal para executar a coleta
    """
    print("üöÄ INICIANDO COLETA DE NOT√çCIAS DO G1")
    print("=" * 50)
    print(f"Data/Hora: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 50)
    
    # Criar inst√¢ncia do scraper
    scraper = G1NewsScraper()
    
    # Coletar not√≠cias
    df = scraper.collect_news()
    
    # Salvar dados
    output_path = scraper.save_data(df)
    
    if output_path:
        print("\nüìä ESTAT√çSTICAS DAS NOT√çCIAS COLETADAS:")
        print(f"‚Ä¢ Total de not√≠cias: {len(df)}")
        print(f"‚Ä¢ Termos de busca: {df['termo_busca'].nunique()}")
        print(f"‚Ä¢ Per√≠odo: {df['data'].min()} a {df['data'].max()}")
        print(f"‚Ä¢ Valor total mencionado: R$ {df['valor_mencionado'].sum():,.2f}")
        
        print("\nüîç DISTRIBUI√á√ÉO POR TERMO:")
        term_counts = df['termo_busca'].value_counts()
        for term, count in term_counts.items():
            print(f"  ‚Ä¢ {term}: {count} not√≠cias")
        
        print("\nüí∞ NOT√çCIAS COM VALORES MONET√ÅRIOS:")
        monetary_news = df[df['valor_mencionado'] > 0]
        if not monetary_news.empty:
            for _, row in monetary_news.iterrows():
                print(f"  ‚Ä¢ {row['titulo'][:60]}... (R$ {row['valor_mencionado']:,.2f})")
    
    print("\n‚úÖ COLETA DO G1 FINALIZADA!")
    return df

if __name__ == "__main__":
    df = main()

